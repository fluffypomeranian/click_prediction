########################### Readme ################################
#   Author:   Tim Siwula
#   Proposal: http://bit.ly/2gcCLQ4
#   Kaggle:   http://bit.ly/2gMVpPG
#   Github:   http://bit.ly/2gZoTwy
#
####################################################################################

########################### Notes ################################
# clear workspace ----> rm(list = ls())
#
####################################################################################

########################### Setup ################################
---
output: pdf_document
---
```{R}
library(knitr)
library(markdown)
#transform the .Rmd to a markdown (.md) file.
knit('tims_script.Rmd')
```
####################################################################################


########################### SET UP DATABASE CONNECTION ################################
```{R}
require("RPostgreSQL")    #install.packages("RPostgreSQL")
driver <- dbDriver("PostgreSQL")   # loads the PostgreSQL driver

# creates a connection to the postgres database
# note that "con" will be used later in each connection to the database
connection <- dbConnect(driver, dbname = "clickprediction",
                 host = "localhost", port = 5432,
                 user = "admin", password = "admin")
# confirm the tables are accessible
dbExistsTable(connection, "clicks_train")  
```
####################################################################################

########################### QUERY THE DATABASE ########################################
```{R}
# 1) 
# try to find features related to ad_id.
# here we join click_train and promoted-content with ad_id.

# look at clicks_train first
getClicksTrain="select * from clicks_train limit 10 "
clicks_train = dbGetQuery(connection, getClicksTrain)
clicks_train

# look at promoted_content next
getPromotedContent="select * from promoted_content limit 10"
promoted_content = dbGetQuery(connection, getPromotedContent)
promoted_content

# join click_train and promoted-content with ad_id new table
# 500k apears to be stable with rstudio.
join_query = "
select t.display_id, t.ad_id, t.clicked, d.document_id,
d.topic_id, d.confidence_level
from clicks_train t, promoted_content p, documents_topics d
where t.ad_id = p.ad_id and p.document_id = d.document_id 
limit 500000;"
merged_table=dbGetQuery(connection, join_query)
head(merged_table, 3)
dim(merged_table)
```
####################################################################################

########################### Create new table -- write new table ########################################
```{R}
dbWriteTable(connection, "merged_table", merged_table, row.names=FALSE)

# look at the new table
getMergedTable="select * from merged_table limit 500000"

new_table = dbGetQuery(connection, getMergedTable)

# list the structure of mydata
str(new_table)
```
####################################################################################

##############################################################################
3) Models and response
Models to consider:
Start with the classification problem first - easier problem - start with decision trees, random forests and bagging
Then switch to regression
```{r}
require(tree)
str(new_table)


hist(new_table$confidence_level)
hist(new_table$clicked)
hist(new_table$display_id)
hist(new_table$ad_id)
hist(new_table$document_id)
hist(new_table$topic_id)
attach(new_table)
confidence20=ifelse(new_table$confidence_level>=0.2,"Yes","No")
str(confidence20)
new_table=data.frame(new_table, confidence20)
tree.local.train.c20=tree(confidence20~.-new_table$confidence_level,data=new_table)
summary(tree.local.train.c20)
plot(tree.local.train.c20)
text(tree.local.train.c20,pretty=0)

```
##############################################################################


########################### create a training set ###########################################
```{R}
# list the structure of mydata
str(new_table)
partition_size = floor(0.80 * nrow(new_table)) ## 80% of the sample size
str(partition_size)
set.seed(123) ## set the seed to make your partition reproductible
partition_index <- sample(seq_len(nrow(new_table)), size = partition_size)
local_train_set <- new_table[partition_index, ]
local_test_set <- new_table[-partition_index, ]

# list the structure of mydata
str(local_test_set)







# print first 10 rows of mydata
#head(mydata, n=10)
```
##############################################################################